---
title: "Models"
author: "Owen Fiore"
date: "2023-02-07"
output: pdf_document
---

```{r}
times <- read.csv("../Data/ThesisData.csv")
colnames(times) <- c("Year", "Type", "Time", "RxnTime", "Gender", "Batch")
```

```{r}
men_finals <- subset(times, Type == "F" & Gender == "M" & Time != 'DQ') # & Year < 2022)
men_pooled <- subset(times, (Type == "F" | Type == "S") & Gender == "M" & Time != 'DQ')
```

```{r}
old_finals <- subset(times, Type == "F" & Gender == "M" & Time != 'DQ' & Year < 2022)
old_pooled <- subset(times, (Type == "F" | Type == "S") & Gender == "M" & Time != 'DQ' & Year < 2022)
```

##Models
```{r}
men_finals_yeareffect <- lmer(RxnTime ~ (1|Year), data = men_finals)
men_pooled_yeareffect <- lmer(RxnTime ~ (1|Year), data = men_pooled)
old_finals_yeareffect <- lmer(RxnTime ~ (1|Year), data = old_finals)
old_pooled_yeareffect <- lmer(RxnTime ~ (1|Year), data = old_pooled)
AIC(men_finals_yeareffect)
AIC(old_finals_yeareffect)
AIC(men_pooled_yeareffect)
AIC(old_pooled_yeareffect)
```

```{r}
men_finals_yeareffect <- lmer(RxnTime ~ (1|Year), data = men_finals)
men_finals_one <- glm(RxnTime ~ 1, data = men_finals)
anova(men_finals_one, men_finals_yeareffect)
AIC(men_finals_one)
AIC(men_finals_yeareffect)
summary(men_finals_yeareffect)
```
```{r}
logLik(men_finals_yeareffect)
logLik(men_finals_one)
```
```{}
For finals only data, the year effect is not helpful
```

```{r}
men_finals_yeareffect_log <- lmer(log(RxnTime) ~ (1|Year), data = men_finals)
men_finals_one_log <- glm(log(RxnTime) ~ 1, data = men_finals)
AIC(men_finals_yeareffect_log)
AIC(men_finals_one_log)
```
```{r}
men_final_yeareffect_gamma <- glmer(RxnTime ~ (1|Year), data = men_finals, family = Gamma)
men_final_one_gamma <- glm(RxnTime ~ 1, data = men_finals, family = Gamma)
AIC(men_final_yeareffect_gamma)
AIC(men_final_one_gamma)
logLik(men_final_yeareffect_gamma)
logLik(men_final_one_gamma)
```
```{}
Should not fit with normal, gamma is better and shows that the year effect is helpful.
Can try this again without last years data.
```

```{r}
old_final_yeareffect_gamma <- glmer(RxnTime ~ (1|Year), data = old_finals, family = Gamma)
old_final_one_gamma <- glm(RxnTime ~ 1, data = old_finals, family = Gamma)
AIC(old_final_yeareffect_gamma)
AIC(old_final_one_gamma)
logLik(old_final_yeareffect_gamma)
logLik(old_final_one_gamma)
summary(old_final_yeareffect_gamma)
summary(men_final_yeareffect_gamma)
```

```{}
Simulate to see what prob of a time less than 0.1 second rxn time.
```



```{}
Thus this seems to support that the 2022 data should be included and that the semifinals and finals should be pooled together.
```


```{r}
trial <- subset(times, Gender == "M" & Time != 'DQ')
x <- lmer(RxnTime ~ (1|Year), data = trial)
AIC(x)
```

```{}
This shows that increasing the data set increases AIC, unsure what we want to use
```


```{r}
#men_finals_randeffect <- lmer(RxnTime ~ 1, data = men_pooled)
men_pooled_yeareffect <- lmer(RxnTime ~ (1|Year), data = men_pooled)
men_pooled_randeffect <- glm(RxnTime ~ 1, data = men_pooled)

anova(men_pooled_yeareffect, men_pooled_randeffect)

```
```{}
As the year effect model is signficant at all alpha levels and the AIC is lower, the year effect is significant and should be considered in the model.  Now we compare the log model to the year effect model
```

```{r}
men_pooled_yeareffect <- lmer(RxnTime ~ (1|Year), data = men_pooled)
men_pooled_log_year <- lmer(log(RxnTime) ~ (1|Year), data = men_pooled)
men_pooled_log <- glm(log(RxnTime) ~ 1, data = men_pooled)
anova(men_pooled_yeareffect, men_pooled_log_year, men_pooled_log)
```
```{}
The year effect model is better than both the log random effect model and the log year effect model.
```

```{r}
library(lme4)
men_pooled_gamma_year <- glmer(RxnTime ~ (1 | Year), data = men_pooled, family = Gamma)
men_pooled_log_gamma_year <- glmer(RxnTime ~ (1 | Year), data = men_pooled, family = Gamma(link = "log"))
men_pooled_yeareffect <- lmer(RxnTime ~ (1|Year), data = men_pooled)

#Compare how much the link=log matters
anova(men_pooled_gamma_year, men_pooled_log_gamma_year)

#Compare gamma and linear
anova(men_pooled_gamma_year, men_pooled_yeareffect)

```
```{}
Whether or not the model contains "(link = "log")" seems to have very little effect on the strength of the model.  The gamma model seems to perform better than the linear model based on AIC, but due to the gamma model being more difficult to interpret, the linear mixed effects model seems sufficient.
```


##Simulations
```{r}
summary(men_pooled_gamma_year)
qqnorm(resid(men_pooled_yeareffect))
qqline(resid(men_pooled_yeareffect))
qqGamma(resid(men_pooled_gamma_year))
```

```{r}
library(qpToolkit)
qqGamma(resid(men_pooled_gamma_year))
```



```{r}
library(DHARMa)
men_pooled_gamma_year <- glmer(RxnTime ~ (1 | Year), data = men_pooled, family = Gamma(link = "log"))
summary(men_pooled_gamma_year)
```
```{r}
simout_gamma <- simulateResiduals(men_pooled_gamma_year, n = 1000)
simout_linear <- simulateResiduals(men_pooled_yeareffect, n = 1000)
plot(simout_gamma)
plot(simout_linear)
#summary(simout)
#str(simout)

```

```{r}
library(lme4)
men_pooled_gamma_year <- glmer(RxnTime ~ (1 | Year), data = men_pooled, family = Gamma(link = "log"))
baseline <- glm(RxnTime ~ 1, data = men_pooled, family = Gamma(link = "log"))

simfit <- function(men_pooled_gamma_year, n = 12000000) {
  vc <- as.data.frame(VarCorr(men_pooled_gamma_year))
  ## mu <- exp(coef(men_pooled_gamma_year)$Year[,]) ## using fitted random effects only
  z <- rnorm(n, sd = vc$sdcor[1]) #$ using generated random effects
  mu <- exp(fixef(men_pooled_gamma_year) + z)
  shape <- 1 / vc$vcov[2]
  x <- rgamma(n, shape = shape, scale = mu / shape)
  x
}
sbaseline <- summary(baseline)
x <- simfit(men_pooled_gamma_year)
mean(x < 0.1)
quantile(x, prob = c(.00001, .0001, .0005, .001))
## compare with and without random effect
plot(density(x)) # with random effect
curve(dgamma(x, shape = 1 / sbaseline$dispersion,
             scale = exp(coef(baseline)) * sbaseline$dispersion),
      0.08, 0.22, add = TRUE, col = "blue") # fixed effect only
```
```{}
Every 1000 racers, we expect 7 to have a reaction time below 0.1 seconds.  If we want 1 out of every 1000
```


##2019 vs 2022 Comparisons
```{r}
comp <- read.csv("../Data/2019vs2022.csv")
#"C:\Users\ofior\Documents\Thesis\Data\2019vs2022.csv"
colnames(comp) <- c("Athlete", "Country", "NineteenH", "NineteenS", "NineteenF", "TwentyTwoH", "TwentyTwoS", "TwentyTwoF")
#View(comp)
```

```{r}
library(clusrank)
t.test(comp$NineteenH, comp$TwentyTwoH, paired = TRUE)
clusWilcox.test(comp$NineteenH, cluster=comp$TwentyTwoH, paired = TRUE, alternative = "greater")
wilcox.test(comp$NineteenH, comp$TwentyTwoH, paired = TRUE)
```


```{r}
t.test(comp$NineteenS, comp$TwentyTwoS, paired = TRUE)
clusWilcox.test(comp$NineteenS, cluster=comp$TwentyTwoS, paired = TRUE, alternative = "greater")
wilcox.test(comp$NineteenS, comp$TwentyTwoS, paired = TRUE)
```
```{}
Cluster by 2019 and 2022
Columns: Athlete, RxnTime, 2019/2022
```


```{}
A matched pairs t test, clusrank package Wilcox test, and a standard Wilcox test all showed that the heat means differ by a significant amount. And two of the three semifinals means had an alpha less than 0.01.
```



```{r}
nations <- read.csv("../Data/NatVSWorld.csv")
colnames(nations) <- c("Athlete", "Country", "NatH", "NatS", "NatF", "WorldH", "WorldS", "WorldF")
```

```{r}
library(clusrank)
t.test(nations$NatH, nations$WorldH, paired = TRUE)
clusWilcox.test(nations$NatH, cluster=nations$WorldH, paired = TRUE, alternative = "greater")
wilcox.test(nations$NatH, nations$WorldH, paired = TRUE)
```
```{}
These p values all significant at alpha = 0.05, but not at alpha = 0.01
```

```{r}
library(clusrank)
t.test(nations$NatS, nations$WorldS, paired = TRUE)
clusWilcox.test(nations$NatS, cluster=nations$WorldS, paired = TRUE, alternative = "greater")
wilcox.test(nations$NatS, nations$WorldS, paired = TRUE)
```
```{}
These p values are all significant at alpha = 0.01
```


